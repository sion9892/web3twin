# 무료 플랜 제한 내 최대 처리 가능 유저 수 계산

## Neynar API 무료 플랜 제한사항

### Rate Limit
- **엔드포인트**: `/v2/farcaster/feed/user/casts`
- **제한**: **60초당 6회** 요청
- **시간 윈도우**: 60초 슬라이딩 윈도우

### 다른 엔드포인트
- `/v2/farcaster/followers`: 별도 제한 (확인 필요)
- `/v2/farcaster/following`: 별도 제한 (확인 필요)
- `/v2/farcaster/user/by_username`: 별도 제한 (확인 필요)

---

## 현재 코드에서 Cast 가져오기 요청 수

### Step2 처리 흐름
1. **사용자 본인 Cast 가져오기**: 1회
   ```typescript
   const casts = await getRecentCasts(userInfo.fid, CAST_LIMIT);
   ```

2. **후보자 Cast 가져오기**: SAMPLE_SIZE × 1회
   - 현재 SAMPLE_SIZE = 40
   - 각 후보자당 1회 Cast 요청
   - 총: 40회 요청

### 총 Cast API 요청 수
```
1 (사용자) + 40 (후보자) = 41회 요청
```

---

## 무료 플랜 제한 계산

### 시나리오 1: 60초 윈도우 내 처리
```
제한: 60초당 6회
필요: 41회

결과: ❌ 불가능 (41 > 6)
```

### 시나리오 2: 순차 처리 + 대기
```
60초당 6회 제한
필요: 41회

대기 횟수: (41 - 6) / 6 = 약 5.83 → 6회 대기 필요
총 시간: 60초 × 6 = 360초 (6분)

처리 가능: ✅ 가능하지만 매우 느림
```

### 시나리오 3: 후보자 수 조정 (제한 내)
```
제한: 60초당 6회
사용: 1회 (사용자 본인)
남은 요청: 6 - 1 = 5회

최대 후보자 수: 5명

총 처리 시간: 약 60-120초 (Rate Limit 고려)
```

---

## 최적화 방안별 계산

### 옵션 1: 후보자 수 감소 (5명)
```
사용자 본인 Cast: 1회
후보자 Cast: 5회
총: 6회

60초 윈도우 내 처리: ✅ 가능
예상 시간: 10-60초
```

### 옵션 2: 배치 처리 + 대기 (40명 유지)
```
배치 크기: 6명씩
배치 수: 40 / 6 = 6.67 → 7배치

각 배치 사이 60초 대기
총 시간: 7 × 60초 = 420초 (7분)

처리 가능: ✅ 가능하지만 매우 느림
```

### 옵션 3: 요청 간격 조절 (40명 유지)
```
60초당 6회 제한
각 요청 간격: 10초

총 요청: 41회
총 시간: 41 × 10초 = 410초 (약 6.8분)

처리 가능: ✅ 가능하지만 매우 느림
```

### 옵션 4: 캐싱 활용
```
이전에 가져온 Cast 캐싱 (예: 1시간)
중복 요청 제거

실제 요청 수 감소 가능
```

---

## 결론: 무료 플랜 내 최대 처리 가능 유저 수

### 즉시 처리 (60초 내)
- **최대 후보자 수**: **5명**
- **총 요청**: 6회 (사용자 1 + 후보자 5)
- **처리 시간**: 약 10-60초

### 대기 시간 허용 (약 7분)
- **최대 후보자 수**: **40명** (현재 설정)
- **총 요청**: 41회
- **처리 시간**: 약 6-7분 (Rate Limit 고려)

### 권장사항
1. **빠른 처리**: 후보자 수를 **5명**으로 감소
2. **현재 기능 유지**: 배치 처리 + 60초 대기로 **40명** 처리 (약 7분 소요)
3. **하이브리드**: 자주 분석하는 유저는 캐싱 활용

---

## 추가 제한사항 고려

### 다른 엔드포인트 Rate Limit
- `/v2/farcaster/followers`: 제한 확인 필요
- `/v2/farcaster/following`: 제한 확인 필요

만약 각각 60초당 6회라면:
```
팔로워 가져오기: 1회
팔로잉 가져오기: 1회
사용자 Cast: 1회
후보자 Cast: 5회 (60초당 6회 제한 내)

총 Cast 요청: 6회 (60초당)
```

---

## 최종 계산

### 무료 플랜 내 최대 즉시 처리 가능
- **후보자 수**: **5명**
- **처리 시간**: **10-60초**
- **Rate Limit 준수**: ✅

### 무료 플랜 내 최대 처리 가능 (대기 허용)
- **후보자 수**: **40명**
- **처리 시간**: **약 6-7분**
- **Rate Limit 준수**: ✅


